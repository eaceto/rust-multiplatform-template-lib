<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kotlin Examples - Rust Multiplatform Template</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3, h4 { color: #004e89; }
        h1 { border-bottom: 3px solid #ff6b35; padding-bottom: 10px; }
        h2 { border-bottom: 2px solid #1a659e; padding-bottom: 8px; margin-top: 30px; }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #1a659e;
            overflow-x: auto;
        }
        pre code {
            background: none;
            padding: 0;
        }
        a { color: #1a659e; text-decoration: none; }
        a:hover { color: #ff6b35; text-decoration: underline; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background: #004e89;
            color: white;
        }
        tr:nth-child(even) { background: #f9f9f9; }
        blockquote {
            border-left: 4px solid #ff6b35;
            padding-left: 20px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        .nav {
            background: #004e89;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        .nav a {
            color: white;
            margin-right: 20px;
            font-weight: 500;
        }
        .nav a:hover { color: #ff6b35; }
    </style>
</head>
<body>
    <div class="nav">
        <a href="index.html">üè† Home</a>
        <a href="README.html">üìã README</a>
        <a href="DEVELOPMENT.html">üîß Development</a>
        <a href="UDL_GUIDE.html">üéØ UDL Guide</a>
        <a href="SWIFT_EXAMPLES.html">üçé Swift Examples</a>
        <a href="KOTLIN_EXAMPLES.html">ü§ñ Kotlin Examples</a>
        <a href="lib/index.html">üìñ API Docs</a>
    </div>
    <div class="container">
        <h1 id="kotlin-usage-examples">Kotlin Usage Examples</h1>
<p>This document shows how to use the Rust template library in Kotlin/Android applications with all the new async-only improvements.</p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#basic-usage">Basic Usage</a></li>
<li><a href="#error-handling">Error Handling</a></li>
<li><a href="#coroutines-and-suspend-functions">Coroutines and Suspend Functions</a></li>
<li><a href="#cancellation">Cancellation</a></li>
<li><a href="#configuration-objects">Configuration Objects</a></li>
<li><a href="#complete-example-app">Complete Example App</a></li>
</ul>
<hr />
<h2 id="basic-usage">Basic Usage</h2>
<h3 id="echo-with-rich-return-type">Echo with Rich Return Type</h3>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">uniffi.rust_multiplatform_template_lib.*</span>

<span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">echoExample</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">echoResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">echo</span><span class="p">(</span><span class="s">&quot;Hello, Kotlin!&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">echoResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Text: </span><span class="si">${</span><span class="n">echoResult</span><span class="p">.</span><span class="na">text</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Length: </span><span class="si">${</span><span class="n">echoResult</span><span class="p">.</span><span class="na">length</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Timestamp: </span><span class="si">${</span><span class="n">echoResult</span><span class="p">.</span><span class="na">timestamp</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>

<span class="w">            </span><span class="n">echoResult</span><span class="p">.</span><span class="na">hash</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Hash: </span><span class="si">$</span><span class="n">hash</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Empty input returned null&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">$</span><span class="n">e</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="random-number-generation">Random Number Generation</h3>
<div class="codehilite"><pre><span></span><code><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">randomExample</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">randomValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random</span><span class="p">()</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Random: </span><span class="si">$</span><span class="n">randomValue</span><span class="s">&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// 0.0 to 1.0</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="error-handling">Error Handling</h2>
<h3 id="structured-error-handling">Structured Error Handling</h3>
<p>The new error system provides structured error information instead of just strings:</p>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">uniffi.rust_multiplatform_template_lib.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.widget.Toast</span>

<span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">processInput</span><span class="p">(</span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">echo</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Success: </span><span class="si">${</span><span class="n">result</span><span class="o">?.</span><span class="na">text</span><span class="w"> </span><span class="o">?:</span><span class="w"> </span><span class="s">&quot;</span><span class="kc">null</span><span class="s">&quot;</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">InputTooLarge</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Input too large!&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;  Size: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">size</span><span class="si">}</span><span class="s"> bytes&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;  Maximum allowed: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">max</span><span class="si">}</span><span class="s"> bytes&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;  Hash (for debugging): </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">hash</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>

<span class="w">                </span><span class="c1">// Show user-friendly message</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">sizeStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">text</span><span class="p">.</span><span class="na">format</span><span class="p">.</span><span class="na">Formatter</span><span class="p">.</span><span class="na">formatFileSize</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">size</span><span class="p">.</span><span class="na">toLong</span><span class="p">())</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">maxStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">text</span><span class="p">.</span><span class="na">format</span><span class="p">.</span><span class="na">Formatter</span><span class="p">.</span><span class="na">formatFileSize</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">max</span><span class="p">.</span><span class="na">toLong</span><span class="p">())</span>

<span class="w">                </span><span class="n">Toast</span><span class="p">.</span><span class="na">makeText</span><span class="p">(</span>
<span class="w">                    </span><span class="n">context</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;Input too large: </span><span class="si">$</span><span class="n">sizeStr</span><span class="s"> exceeds maximum of </span><span class="si">$</span><span class="n">maxStr</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">Toast</span><span class="p">.</span><span class="na">LENGTH_LONG</span>
<span class="w">                </span><span class="p">).</span><span class="na">show</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">InvalidInput</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Invalid input: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">message</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">inputPreview</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">preview</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;  Preview: </span><span class="si">$</span><span class="n">preview</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="n">Toast</span><span class="p">.</span><span class="na">makeText</span><span class="p">(</span>
<span class="w">                    </span><span class="n">context</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;Invalid input: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">message</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">Toast</span><span class="p">.</span><span class="na">LENGTH_SHORT</span>
<span class="w">                </span><span class="p">).</span><span class="na">show</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">OperationCancelled</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Operation cancelled: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">operation</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>

<span class="w">                </span><span class="n">Toast</span><span class="p">.</span><span class="na">makeText</span><span class="p">(</span>
<span class="w">                    </span><span class="n">context</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;Operation was cancelled&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">Toast</span><span class="p">.</span><span class="na">LENGTH_SHORT</span>
<span class="w">                </span><span class="p">).</span><span class="na">show</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="practical-error-handling-in-activity">Practical Error Handling in Activity</h3>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">android.os.Bundle</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.widget.Button</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.widget.EditText</span>
<span class="k">import</span><span class="w"> </span><span class="nn">android.widget.TextView</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.appcompat.app.AppCompatActivity</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.lifecycle.lifecycleScope</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlinx.coroutines.launch</span>
<span class="k">import</span><span class="w"> </span><span class="nn">uniffi.rust_multiplatform_template_lib.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.text.SimpleDateFormat</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.util.*</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">InputActivity</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">AppCompatActivity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">inputField</span><span class="p">:</span><span class="w"> </span><span class="n">EditText</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">resultView</span><span class="p">:</span><span class="w"> </span><span class="n">TextView</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">processButton</span><span class="p">:</span><span class="w"> </span><span class="n">Button</span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span><span class="w"> </span><span class="n">Bundle?)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
<span class="w">        </span><span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">layout</span><span class="p">.</span><span class="na">activity_input</span><span class="p">)</span>

<span class="w">        </span><span class="n">inputField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">inputField</span><span class="p">)</span>
<span class="w">        </span><span class="n">resultView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">resultView</span><span class="p">)</span>
<span class="w">        </span><span class="n">processButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">processButton</span><span class="p">)</span>

<span class="w">        </span><span class="n">processButton</span><span class="p">.</span><span class="na">setOnClickListener</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputField</span><span class="p">.</span><span class="na">text</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">resultView</span><span class="p">.</span><span class="na">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Please enter some text&quot;</span>
<span class="w">                </span><span class="k">return</span><span class="nd">@setOnClickListener</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">lifecycleScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">processInputAsync</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">processInputAsync</span><span class="p">(</span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">echo</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">dateFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SimpleDateFormat</span><span class="p">(</span><span class="s">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Locale</span><span class="p">.</span><span class="na">US</span><span class="p">)</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Date</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">timestamp</span><span class="p">.</span><span class="na">toLong</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span>

<span class="w">                </span><span class="n">resultView</span><span class="p">.</span><span class="na">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">                    Result: </span><span class="si">${</span><span class="n">result</span><span class="p">.</span><span class="na">text</span><span class="si">}</span>
<span class="s">                    Length: </span><span class="si">${</span><span class="n">result</span><span class="p">.</span><span class="na">length</span><span class="si">}</span><span class="s"> characters</span>
<span class="s">                    Time: </span><span class="si">${</span><span class="n">dateFormat</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="si">}</span>
<span class="s">                &quot;&quot;&quot;</span><span class="p">.</span><span class="na">trimIndent</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">handleTemplateError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">handleTemplateError</span><span class="p">(</span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">InputTooLarge</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">sizeStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">text</span><span class="p">.</span><span class="na">format</span><span class="p">.</span><span class="na">Formatter</span><span class="p">.</span><span class="na">formatFileSize</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="na">size</span><span class="p">.</span><span class="na">toLong</span><span class="p">())</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">maxStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">text</span><span class="p">.</span><span class="na">format</span><span class="p">.</span><span class="na">Formatter</span><span class="p">.</span><span class="na">formatFileSize</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="na">max</span><span class="p">.</span><span class="na">toLong</span><span class="p">())</span>

<span class="w">                </span><span class="n">resultView</span><span class="p">.</span><span class="na">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">                    ‚ùå Input too large</span>
<span class="s">                    Your input: </span><span class="si">$</span><span class="n">sizeStr</span>
<span class="s">                    Maximum: </span><span class="si">$</span><span class="n">maxStr</span>
<span class="s">                &quot;&quot;&quot;</span><span class="p">.</span><span class="na">trimIndent</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">InvalidInput</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;‚ùå Invalid input: </span><span class="si">${</span><span class="n">error</span><span class="p">.</span><span class="na">message</span><span class="si">}</span><span class="s">&quot;</span>
<span class="w">                </span><span class="n">error</span><span class="p">.</span><span class="na">inputPreview</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">preview</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">text</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;\nPreview: </span><span class="si">$</span><span class="n">preview</span><span class="s">&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">resultView</span><span class="p">.</span><span class="na">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">text</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">OperationCancelled</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">resultView</span><span class="p">.</span><span class="na">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;‚ö†Ô∏è </span><span class="si">${</span><span class="n">error</span><span class="p">.</span><span class="na">operation</span><span class="si">}</span><span class="s"> was cancelled&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="coroutines-and-suspend-functions">Coroutines and Suspend Functions</h2>
<h3 id="basic-async-echo">Basic Async Echo</h3>
<p>All functions in the library are now suspend functions and must be called from a coroutine context:</p>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">kotlinx.coroutines.runBlocking</span>
<span class="k">import</span><span class="w"> </span><span class="nn">uniffi.rust_multiplatform_template_lib.*</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">asyncExample</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runBlocking</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">echo</span><span class="p">(</span><span class="s">&quot;Async hello!&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>

<span class="w">        </span><span class="n">result</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Async result: </span><span class="si">${</span><span class="nb">it</span><span class="p">.</span><span class="na">text</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Completed at: </span><span class="si">${</span><span class="nb">it</span><span class="p">.</span><span class="na">timestamp</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">OperationCancelled</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Cancelled: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">operation</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">InputTooLarge</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Too large: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">size</span><span class="si">}</span><span class="s"> &gt; </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">max</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">InvalidInput</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Invalid: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">message</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="using-with-jetpack-compose">Using with Jetpack Compose</h3>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.layout.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.material3.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.runtime.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.Modifier</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.unit.dp</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlinx.coroutines.launch</span>
<span class="k">import</span><span class="w"> </span><span class="nn">uniffi.rust_multiplatform_template_lib.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.text.SimpleDateFormat</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.util.*</span>

<span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">AsyncEchoScreen</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="o">&lt;</span><span class="n">EchoResult?&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">isLoading</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="o">&lt;</span><span class="n">TemplateException?&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rememberCoroutineScope</span><span class="p">()</span>

<span class="w">    </span><span class="n">Column</span><span class="p">(</span>
<span class="w">        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">            </span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
<span class="w">        </span><span class="n">verticalArrangement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrangement</span><span class="p">.</span><span class="na">spacedBy</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">OutlinedTextField</span><span class="p">(</span>
<span class="w">            </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">,</span>
<span class="w">            </span><span class="n">onValueChange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">it</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Enter text&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">()</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="n">Button</span><span class="p">(</span>
<span class="w">            </span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">scope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">processAsync</span><span class="p">(</span>
<span class="w">                        </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">,</span>
<span class="w">                        </span><span class="n">onLoading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">isLoading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">it</span><span class="w"> </span><span class="p">},</span>
<span class="w">                        </span><span class="n">onResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">it</span><span class="w"> </span><span class="p">},</span>
<span class="w">                        </span><span class="n">onError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">it</span><span class="w"> </span><span class="p">}</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">isLoading</span><span class="p">,</span>
<span class="w">            </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">()</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Process Async&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isLoading</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">CircularProgressIndicator</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">result</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">echoResult</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">dateFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SimpleDateFormat</span><span class="p">(</span><span class="s">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Locale</span><span class="p">.</span><span class="na">US</span><span class="p">)</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Date</span><span class="p">(</span><span class="n">echoResult</span><span class="p">.</span><span class="na">timestamp</span><span class="p">.</span><span class="na">toLong</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span>

<span class="w">            </span><span class="n">Card</span><span class="p">(</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">(),</span>
<span class="w">                </span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CardDefaults</span><span class="p">.</span><span class="na">cardColors</span><span class="p">(</span>
<span class="w">                    </span><span class="n">containerColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colorScheme</span><span class="p">.</span><span class="na">primaryContainer</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Column</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Result: </span><span class="si">${</span><span class="n">echoResult</span><span class="p">.</span><span class="na">text</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Length: </span><span class="si">${</span><span class="n">echoResult</span><span class="p">.</span><span class="na">length</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Time: </span><span class="si">${</span><span class="n">dateFormat</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">error</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">templateError</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">ErrorCard</span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">templateError</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">ErrorCard</span><span class="p">(</span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Card</span><span class="p">(</span>
<span class="w">        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">(),</span>
<span class="w">        </span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CardDefaults</span><span class="p">.</span><span class="na">cardColors</span><span class="p">(</span>
<span class="w">            </span><span class="n">containerColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colorScheme</span><span class="p">.</span><span class="na">errorContainer</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Column</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">InputTooLarge</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;‚ùå Input Too Large&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">titleMedium</span><span class="p">)</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Size: </span><span class="si">${</span><span class="n">android</span><span class="p">.</span><span class="na">text</span><span class="p">.</span><span class="na">format</span><span class="p">.</span><span class="na">Formatter</span><span class="p">.</span><span class="na">formatFileSize</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="na">size</span><span class="p">.</span><span class="na">toLong</span><span class="p">())</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Max: </span><span class="si">${</span><span class="n">android</span><span class="p">.</span><span class="na">text</span><span class="p">.</span><span class="na">format</span><span class="p">.</span><span class="na">Formatter</span><span class="p">.</span><span class="na">formatFileSize</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="na">max</span><span class="p">.</span><span class="na">toLong</span><span class="p">())</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">InvalidInput</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;‚ùå Invalid Input&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">titleMedium</span><span class="p">)</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="na">message</span><span class="p">)</span>
<span class="w">                    </span><span class="n">error</span><span class="p">.</span><span class="na">inputPreview</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">preview</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                        </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Preview: </span><span class="si">$</span><span class="n">preview</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">bodySmall</span><span class="p">)</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">OperationCancelled</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;‚ö†Ô∏è Cancelled&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">titleMedium</span><span class="p">)</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Operation: </span><span class="si">${</span><span class="n">error</span><span class="p">.</span><span class="na">operation</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">processAsync</span><span class="p">(</span>
<span class="w">    </span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">onLoading</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="kt">Boolean</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="p">,</span>
<span class="w">    </span><span class="n">onResult</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">EchoResult?)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="p">,</span>
<span class="w">    </span><span class="n">onError</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">TemplateException?)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">onLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="n">onError</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="n">onResult</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">echo</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">        </span><span class="n">onResult</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">onError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">onLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="cancellation">Cancellation</h2>
<h3 id="basic-cancellation">Basic Cancellation</h3>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">kotlinx.coroutines.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">uniffi.rust_multiplatform_template_lib.*</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">cancellableOperation</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runBlocking</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">cancellationToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CancellationToken</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Start async operation</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">echo</span><span class="p">(</span>
<span class="w">                </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Long running operation&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cancellationToken</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Completed: </span><span class="si">${</span><span class="n">result</span><span class="o">?.</span><span class="na">text</span><span class="w"> </span><span class="o">?:</span><span class="w"> </span><span class="s">&quot;</span><span class="kc">null</span><span class="s">&quot;</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">OperationCancelled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Successfully cancelled: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">operation</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Cancel after 1 second</span>
<span class="w">    </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
<span class="w">        </span><span class="n">cancellationToken</span><span class="p">.</span><span class="na">cancel</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">job</span><span class="p">.</span><span class="na">join</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="cancellation-with-jetpack-compose">Cancellation with Jetpack Compose</h3>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.layout.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.material3.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.runtime.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.Modifier</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.unit.dp</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlinx.coroutines.launch</span>
<span class="k">import</span><span class="w"> </span><span class="nn">uniffi.rust_multiplatform_template_lib.*</span>

<span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">CancellableScreen</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="o">&lt;</span><span class="n">EchoResult?&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">isProcessing</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">cancellationToken</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="o">&lt;</span><span class="n">CancellationToken?&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">remember</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mutableStateOf</span><span class="o">&lt;</span><span class="kt">String?</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rememberCoroutineScope</span><span class="p">()</span>

<span class="w">    </span><span class="n">Column</span><span class="p">(</span>
<span class="w">        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">            </span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
<span class="w">        </span><span class="n">verticalArrangement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrangement</span><span class="p">.</span><span class="na">spacedBy</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">OutlinedTextField</span><span class="p">(</span>
<span class="w">            </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">,</span>
<span class="w">            </span><span class="n">onValueChange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">it</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Enter text&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">()</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="n">Row</span><span class="p">(</span>
<span class="w">            </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">(),</span>
<span class="w">            </span><span class="n">horizontalArrangement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrangement</span><span class="p">.</span><span class="na">spacedBy</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Button</span><span class="p">(</span>
<span class="w">                </span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">scope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">startProcessing</span><span class="p">(</span>
<span class="w">                            </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">,</span>
<span class="w">                            </span><span class="n">onProcessing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">isProcessing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">it</span><span class="w"> </span><span class="p">},</span>
<span class="w">                            </span><span class="n">onToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">cancellationToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">it</span><span class="w"> </span><span class="p">},</span>
<span class="w">                            </span><span class="n">onResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">it</span><span class="w"> </span><span class="p">},</span>
<span class="w">                            </span><span class="n">onError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">it</span><span class="w"> </span><span class="p">}</span>
<span class="w">                        </span><span class="p">)</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">isProcessing</span><span class="p">,</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Start&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">Button</span><span class="p">(</span>
<span class="w">                </span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">cancellationToken</span><span class="o">?.</span><span class="na">cancel</span><span class="p">()</span><span class="w"> </span><span class="p">},</span>
<span class="w">                </span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isProcessing</span><span class="p">,</span>
<span class="w">                </span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ButtonDefaults</span><span class="p">.</span><span class="na">buttonColors</span><span class="p">(</span>
<span class="w">                    </span><span class="n">containerColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colorScheme</span><span class="p">.</span><span class="na">error</span>
<span class="w">                </span><span class="p">),</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Cancel&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isProcessing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">LinearProgressIndicator</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">())</span>
<span class="w">            </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Processing...&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">result</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">echoResult</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">Card</span><span class="p">(</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">(),</span>
<span class="w">                </span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CardDefaults</span><span class="p">.</span><span class="na">cardColors</span><span class="p">(</span>
<span class="w">                    </span><span class="n">containerColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colorScheme</span><span class="p">.</span><span class="na">primaryContainer</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                    </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Result: </span><span class="si">${</span><span class="n">echoResult</span><span class="p">.</span><span class="na">text</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">error</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">errorMsg</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">errorMsg</span><span class="p">,</span>
<span class="w">                </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colorScheme</span><span class="p">.</span><span class="na">error</span><span class="p">,</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">startProcessing</span><span class="p">(</span>
<span class="w">    </span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">onProcessing</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="kt">Boolean</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="p">,</span>
<span class="w">    </span><span class="n">onToken</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">CancellationToken?)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="p">,</span>
<span class="w">    </span><span class="n">onResult</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">EchoResult?)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="p">,</span>
<span class="w">    </span><span class="n">onError</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="kt">String?</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">onProcessing</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="n">onError</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="n">onResult</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Create new cancellation token</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CancellationToken</span><span class="p">()</span>
<span class="w">    </span><span class="n">onToken</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">processResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">echo</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">        </span><span class="n">onResult</span><span class="p">(</span><span class="n">processResult</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">OperationCancelled</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">onError</span><span class="p">(</span><span class="s">&quot;Operation was cancelled&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">onError</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">message</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">onProcessing</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="n">onToken</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="using-kotlin-coroutine-cancellation-with-cancellationtoken">Using Kotlin Coroutine Cancellation with CancellationToken</h3>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">kotlinx.coroutines.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">uniffi.rust_multiplatform_template_lib.*</span>

<span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">cancellableWithTimeout</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coroutineScope</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">cancellationToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CancellationToken</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Link Kotlin coroutine cancellation with the native token</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">echo</span><span class="p">(</span><span class="s">&quot;Long operation&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cancellationToken</span><span class="p">)</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Success: </span><span class="si">${</span><span class="n">result</span><span class="o">?.</span><span class="na">text</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">OperationCancelled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Native cancellation detected&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">CancellationException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Kotlin coroutine cancelled&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="n">cancellationToken</span><span class="p">.</span><span class="na">cancel</span><span class="p">()</span><span class="w"> </span><span class="c1">// Cancel native operation too</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Cancel after timeout</span>
<span class="w">    </span><span class="n">withTimeoutOrNull</span><span class="p">(</span><span class="m">2000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">job</span><span class="p">.</span><span class="na">join</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">?:</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Timeout - cancelling&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">cancellationToken</span><span class="p">.</span><span class="na">cancel</span><span class="p">()</span>
<span class="w">        </span><span class="n">job</span><span class="p">.</span><span class="na">cancelAndJoin</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="configuration-objects">Configuration Objects</h2>
<h3 id="using-templateconfig">Using TemplateConfig</h3>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">uniffi.rust_multiplatform_template_lib.*</span>

<span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">configExample</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Create configuration with custom settings</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplateConfig</span><span class="p">(</span>
<span class="w">        </span><span class="n">maxInputSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="n">u</span><span class="p">,</span><span class="w">  </span><span class="c1">// 1KB limit</span>
<span class="w">        </span><span class="n">enableValidation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Max size: </span><span class="si">${</span><span class="n">config</span><span class="p">.</span><span class="na">maxInputSize</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Validation: </span><span class="si">${</span><span class="n">config</span><span class="p">.</span><span class="na">enableValidation</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Use the config</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">validateAndEcho</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">        </span><span class="n">result</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Validated: </span><span class="si">${</span><span class="nb">it</span><span class="p">.</span><span class="na">text</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Validation failed: </span><span class="si">$</span><span class="n">e</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="configuration-manager-pattern">Configuration Manager Pattern</h3>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">uniffi.rust_multiplatform_template_lib.*</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">TemplateManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">standardConfig</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplateConfig</span><span class="p">(</span>
<span class="w">        </span><span class="n">maxInputSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="n">_000_000u</span><span class="p">,</span><span class="w">  </span><span class="c1">// 1MB</span>
<span class="w">        </span><span class="n">enableValidation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">strictConfig</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplateConfig</span><span class="p">(</span>
<span class="w">        </span><span class="n">maxInputSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="n">_000u</span><span class="p">,</span><span class="w">  </span><span class="c1">// 10KB</span>
<span class="w">        </span><span class="n">enableValidation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">processWithStandardConfig</span><span class="p">(</span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">):</span><span class="w"> </span><span class="n">EchoResult? </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">standardConfig</span><span class="p">.</span><span class="na">validateAndEcho</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">processWithStrictConfig</span><span class="p">(</span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">):</span><span class="w"> </span><span class="n">EchoResult? </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">strictConfig</span><span class="p">.</span><span class="na">validateAndEcho</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">validateInput</span><span class="p">(</span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">strict</span><span class="p">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">):</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strict</span><span class="p">)</span><span class="w"> </span><span class="n">strictConfig</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">standardConfig</span>
<span class="w">            </span><span class="n">config</span><span class="p">.</span><span class="na">validateAndEcho</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">            </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kc">false</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Usage</span>
<span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">managerExample</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplateManager</span><span class="p">()</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="na">processWithStandardConfig</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Processed: </span><span class="si">${</span><span class="n">result</span><span class="o">?.</span><span class="na">text</span><span class="w"> </span><span class="o">?:</span><span class="w"> </span><span class="s">&quot;</span><span class="kc">null</span><span class="s">&quot;</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">InputTooLarge</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Input </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">size</span><span class="si">}</span><span class="s"> exceeds limit </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">max</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">InvalidInput</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Invalid: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">message</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">OperationCancelled</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Cancelled&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="dsl-builder-pattern">DSL Builder Pattern</h3>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">com.rust.template.extensions.*</span>

<span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">dslExample</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Using the DSL builder from TemplateExtensions.kt</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">templateConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">maxInputSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5000</span><span class="n">u</span>
<span class="w">        </span><span class="n">enableValidation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">validateAndEcho</span><span class="p">(</span><span class="s">&quot;Hello from DSL&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Result: </span><span class="si">${</span><span class="n">result</span><span class="o">?.</span><span class="na">text</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">detailedDescription</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Error code: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">errorCode</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Recoverable: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">isRecoverable</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="complete-example-app">Complete Example App</h2>
<p>Here's a complete Android app showcasing all features:</p>
<h3 id="viewmodel">ViewModel</h3>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">androidx.lifecycle.ViewModel</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.lifecycle.viewModelScope</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlinx.coroutines.flow.MutableStateFlow</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlinx.coroutines.flow.StateFlow</span>
<span class="k">import</span><span class="w"> </span><span class="nn">kotlinx.coroutines.launch</span>
<span class="k">import</span><span class="w"> </span><span class="nn">uniffi.rust_multiplatform_template_lib.*</span>

<span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">AppState</span><span class="p">(</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">input</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="p">:</span><span class="w"> </span><span class="kt">String?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">error</span><span class="p">:</span><span class="w"> </span><span class="kt">String?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">isProcessing</span><span class="p">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="p">)</span>

<span class="kd">class</span><span class="w"> </span><span class="nc">TemplateViewModel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ViewModel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MutableStateFlow</span><span class="p">(</span><span class="n">AppState</span><span class="p">())</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">state</span><span class="p">:</span><span class="w"> </span><span class="n">StateFlow</span><span class="o">&lt;</span><span class="n">AppState</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">cancellationToken</span><span class="p">:</span><span class="w"> </span><span class="n">CancellationToken? </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TemplateConfig</span><span class="p">(</span>
<span class="w">        </span><span class="n">maxInputSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="n">_000_000u</span><span class="p">,</span>
<span class="w">        </span><span class="n">enableValidation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">updateInput</span><span class="p">(</span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">testRandom</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random</span><span class="p">()</span>
<span class="w">                </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span>
<span class="w">                    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Random: %.6f&quot;</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
<span class="w">                    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">Exception</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span>
<span class="w">                    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Error: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">message</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">echoAsync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">echo</span><span class="p">(</span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">input</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span>
<span class="w">                        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">                            Text: </span><span class="si">${</span><span class="n">result</span><span class="p">.</span><span class="na">text</span><span class="si">}</span>
<span class="s">                            Length: </span><span class="si">${</span><span class="n">result</span><span class="p">.</span><span class="na">length</span><span class="si">}</span>
<span class="s">                            Timestamp: </span><span class="si">${</span><span class="n">result</span><span class="p">.</span><span class="na">timestamp</span><span class="si">}</span>
<span class="s">                        &quot;&quot;&quot;</span><span class="p">.</span><span class="na">trimIndent</span><span class="p">(),</span>
<span class="w">                        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span>
<span class="w">                        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Empty input&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span>
<span class="w">                    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">formatError</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<span class="w">                    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">startLongOperation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span>
<span class="w">                </span><span class="n">isProcessing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">                </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">                </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="n">cancellationToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CancellationToken</span><span class="p">()</span>

<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">echo</span><span class="p">(</span>
<span class="w">                    </span><span class="s">&quot;Long operation: </span><span class="si">${</span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">input</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">cancellationToken</span>
<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="n">result</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span>
<span class="w">                        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Completed: </span><span class="si">${</span><span class="nb">it</span><span class="p">.</span><span class="na">text</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="n">isProcessing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_state</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span>
<span class="w">                    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">formatError</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<span class="w">                    </span><span class="n">isProcessing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">cancellationToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">cancelOperation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cancellationToken</span><span class="o">?.</span><span class="na">cancel</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">formatError</span><span class="p">(</span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">):</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">InputTooLarge</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">sizeStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">text</span><span class="p">.</span><span class="na">format</span><span class="p">.</span><span class="na">Formatter</span><span class="p">.</span><span class="na">formatFileSize</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="na">size</span><span class="p">.</span><span class="na">toLong</span><span class="p">())</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">maxStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">text</span><span class="p">.</span><span class="na">format</span><span class="p">.</span><span class="na">Formatter</span><span class="p">.</span><span class="na">formatFileSize</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="na">max</span><span class="p">.</span><span class="na">toLong</span><span class="p">())</span>
<span class="w">                </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">                    Input too large:</span>
<span class="s">                    Size: </span><span class="si">$</span><span class="n">sizeStr</span>
<span class="s">                    Max: </span><span class="si">$</span><span class="n">maxStr</span>
<span class="s">                    Hash: </span><span class="si">${</span><span class="n">error</span><span class="p">.</span><span class="na">hash</span><span class="si">}</span>
<span class="s">                &quot;&quot;&quot;</span><span class="p">.</span><span class="na">trimIndent</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">InvalidInput</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Invalid input: </span><span class="si">${</span><span class="n">error</span><span class="p">.</span><span class="na">message</span><span class="si">}</span><span class="s">&quot;</span>
<span class="w">                </span><span class="n">error</span><span class="p">.</span><span class="na">inputPreview</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">preview</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">text</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;\nPreview: </span><span class="si">$</span><span class="n">preview</span><span class="s">&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">text</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">.</span><span class="na">OperationCancelled</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="s">&quot;Cancelled: </span><span class="si">${</span><span class="n">error</span><span class="p">.</span><span class="na">operation</span><span class="si">}</span><span class="s">&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="compose-ui">Compose UI</h3>
<div class="codehilite"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.layout.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.rememberScrollState</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.foundation.verticalScroll</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.material3.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.runtime.*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.Modifier</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.compose.ui.unit.dp</span>
<span class="k">import</span><span class="w"> </span><span class="nn">androidx.lifecycle.viewmodel.compose.viewModel</span>

<span class="nd">@OptIn</span><span class="p">(</span><span class="n">ExperimentalMaterial3Api</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="nd">@Composable</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">TemplateApp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">viewModel</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateViewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">state</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="na">state</span><span class="p">.</span><span class="na">collectAsState</span><span class="p">()</span>

<span class="w">    </span><span class="n">Scaffold</span><span class="p">(</span>
<span class="w">        </span><span class="n">topBar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">TopAppBar</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Template Library&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">paddingValues</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">Column</span><span class="p">(</span>
<span class="w">            </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span>
<span class="w">                </span><span class="p">.</span><span class="na">fillMaxSize</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">verticalScroll</span><span class="p">(</span><span class="n">rememberScrollState</span><span class="p">()),</span>
<span class="w">            </span><span class="n">verticalArrangement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrangement</span><span class="p">.</span><span class="na">spacedBy</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Basic Operations Section</span>
<span class="w">            </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Basic Operations&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">titleLarge</span><span class="p">)</span>

<span class="w">            </span><span class="n">Button</span><span class="p">(</span>
<span class="w">                </span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="na">testRandom</span><span class="p">()</span><span class="w"> </span><span class="p">},</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">()</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Random&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">Divider</span><span class="p">()</span>

<span class="w">            </span><span class="c1">// Echo Section</span>
<span class="w">            </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Echo&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">titleLarge</span><span class="p">)</span>

<span class="w">            </span><span class="n">OutlinedTextField</span><span class="p">(</span>
<span class="w">                </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">input</span><span class="p">,</span>
<span class="w">                </span><span class="n">onValueChange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="na">updateInput</span><span class="p">(</span><span class="nb">it</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="w">                </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Input&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">()</span>
<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="n">Button</span><span class="p">(</span>
<span class="w">                </span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="na">echoAsync</span><span class="p">()</span><span class="w"> </span><span class="p">},</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">()</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Echo Async&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">Divider</span><span class="p">()</span>

<span class="w">            </span><span class="c1">// Async with Cancellation Section</span>
<span class="w">            </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Async with Cancellation&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">titleLarge</span><span class="p">)</span>

<span class="w">            </span><span class="n">Row</span><span class="p">(</span>
<span class="w">                </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">(),</span>
<span class="w">                </span><span class="n">horizontalArrangement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrangement</span><span class="p">.</span><span class="na">spacedBy</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Button</span><span class="p">(</span>
<span class="w">                    </span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="na">startLongOperation</span><span class="p">()</span><span class="w"> </span><span class="p">},</span>
<span class="w">                    </span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">state</span><span class="p">.</span><span class="na">isProcessing</span><span class="p">,</span>
<span class="w">                    </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">)</span>
<span class="w">                </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Start Long Operation&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="n">Button</span><span class="p">(</span>
<span class="w">                    </span><span class="n">onClick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="na">cancelOperation</span><span class="p">()</span><span class="w"> </span><span class="p">},</span>
<span class="w">                    </span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="na">isProcessing</span><span class="p">,</span>
<span class="w">                    </span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ButtonDefaults</span><span class="p">.</span><span class="na">buttonColors</span><span class="p">(</span>
<span class="w">                        </span><span class="n">containerColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colorScheme</span><span class="p">.</span><span class="na">error</span>
<span class="w">                    </span><span class="p">),</span>
<span class="w">                    </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">)</span>
<span class="w">                </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Cancel&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="na">isProcessing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">LinearProgressIndicator</span><span class="p">(</span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">())</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">Divider</span><span class="p">()</span>

<span class="w">            </span><span class="c1">// Result Section</span>
<span class="w">            </span><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Result&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">typography</span><span class="p">.</span><span class="na">titleLarge</span><span class="p">)</span>

<span class="w">            </span><span class="n">state</span><span class="p">.</span><span class="na">result</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">Card</span><span class="p">(</span>
<span class="w">                    </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CardDefaults</span><span class="p">.</span><span class="na">cardColors</span><span class="p">(</span>
<span class="w">                        </span><span class="n">containerColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colorScheme</span><span class="p">.</span><span class="na">primaryContainer</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">                </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                        </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">                        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
<span class="w">                        </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colorScheme</span><span class="p">.</span><span class="na">onPrimaryContainer</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">state</span><span class="p">.</span><span class="na">error</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">Card</span><span class="p">(</span>
<span class="w">                    </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">fillMaxWidth</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CardDefaults</span><span class="p">.</span><span class="na">cardColors</span><span class="p">(</span>
<span class="w">                        </span><span class="n">containerColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colorScheme</span><span class="p">.</span><span class="na">errorContainer</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">                </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">Text</span><span class="p">(</span>
<span class="w">                        </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error</span><span class="p">,</span>
<span class="w">                        </span><span class="n">modifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Modifier</span><span class="p">.</span><span class="na">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
<span class="w">                        </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaterialTheme</span><span class="p">.</span><span class="na">colorScheme</span><span class="p">.</span><span class="na">onErrorContainer</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="best-practices">Best Practices</h2>
<ol>
<li><strong>Always use suspend functions</strong> - All library functions are async and must be called from coroutine contexts</li>
<li><strong>Handle errors explicitly</strong> - Don't just catch and ignore, provide meaningful feedback</li>
<li><strong>Use structured error matching</strong> - Pattern match on error variants for better UX</li>
<li><strong>Cancel long operations</strong> - Implement cancellation for better user experience</li>
<li><strong>Use configuration objects</strong> - For reusable validation settings</li>
<li><strong>Link coroutine cancellation</strong> - Connect Kotlin coroutine cancellation with native CancellationToken</li>
<li><strong>Use DSL builders</strong> - For clean, idiomatic Kotlin configuration</li>
<li><strong>Collect StateFlow on main thread</strong> - When updating UI in Compose or Activities</li>
<li><strong>Use viewModelScope</strong> - For automatic cancellation when ViewModel is cleared</li>
<li><strong>Format file sizes properly</strong> - Use Android's <code>Formatter.formatFileSize()</code> for user-friendly messages</li>
</ol>
<hr />
<h2 id="extension-functions">Extension Functions</h2>
<p>The library provides rich Kotlin extensions in <code>TemplateExtensions.kt</code>:</p>
<h3 id="echoresult-extensions">EchoResult Extensions</h3>
<div class="codehilite"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">echo</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="n">result</span><span class="o">?.</span><span class="na">let</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="nb">it</span><span class="p">.</span><span class="na">description</span><span class="p">)</span><span class="w">          </span><span class="c1">// Human-readable description</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="nb">it</span><span class="p">.</span><span class="na">formattedTimestamp</span><span class="p">)</span><span class="w">   </span><span class="c1">// Formatted date string</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="nb">it</span><span class="p">.</span><span class="na">formattedHash</span><span class="p">)</span><span class="w">        </span><span class="c1">// Pretty-printed hash</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="nb">it</span><span class="p">.</span><span class="na">hasHash</span><span class="p">)</span><span class="w">              </span><span class="c1">// Boolean check</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="templateexception-extensions">TemplateException Extensions</h3>
<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">echo</span><span class="p">(</span><span class="n">largeInput</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TemplateException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">detailedDescription</span><span class="p">)</span><span class="w">  </span><span class="c1">// Full error description</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">errorCode</span><span class="p">)</span><span class="w">            </span><span class="c1">// Error code for logging</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">isRecoverable</span><span class="p">)</span><span class="w">        </span><span class="c1">// Whether user can retry</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="cancellationtoken-extensions">CancellationToken Extensions</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Auto-cancel after timeout</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CancellationToken</span><span class="p">.</span><span class="na">withTimeout</span><span class="p">(</span><span class="m">5.</span><span class="n">seconds</span><span class="p">)</span>

<span class="c1">// Check if active</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="na">isActive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Perform operation</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="helper-functions">Helper Functions</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Safe operation with Result type</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="p">:</span><span class="w"> </span><span class="n">Result</span><span class="o">&lt;</span><span class="n">EchoResult?&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">safeTemplateOperationAsync</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">echo</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Operation with timeout</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">withTemplateTimeout</span><span class="p">(</span><span class="m">3.</span><span class="n">seconds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">echo</span><span class="p">(</span><span class="s">&quot;long input&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Retry with backoff</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retryTemplateOperation</span><span class="p">(</span>
<span class="w">    </span><span class="n">maxAttempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span>
<span class="w">    </span><span class="n">delayBetweenAttempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100.</span><span class="n">milliseconds</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">echo</span><span class="p">(</span><span class="s">&quot;flaky operation&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<p><em>Last updated: 2025-01-11</em></p>
    </div>
</body>
</html>