name: Deploy Documentation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-docs:
    name: Generate Rust Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-rust-docs-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-rust-docs-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-rust-docs-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Generate Rust documentation
        run: ./scripts/doc-all.sh

      - name: Upload Rust documentation
        uses: actions/upload-artifact@v4
        with:
          name: rust-docs
          path: docs/
          retention-days: 1

  build-apple:
    name: Build Apple Platforms
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust targets (Apple only)
        run: |
          rustup target add aarch64-apple-ios
          rustup target add aarch64-apple-ios-sim
          rustup target add x86_64-apple-ios
          rustup target add aarch64-apple-darwin

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-apple-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-apple-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-apple-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Apple platforms
        run: ./scripts/build-apple.sh

      - name: Upload Apple artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apple-build
          path: platforms/apple/xcframework/
          retention-days: 1

  build-android:
    name: Build Android/JVM Platforms
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d
          add-to-path: true

      - name: Install Rust targets (Android/JVM only)
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-android-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-android-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-android-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Android/JVM platforms
        run: ./scripts/build-kotlin.sh
        env:
          NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: |
            platforms/kotlin/src/jniLibs/
            platforms/kotlin/src/commonMain/kotlin/
          retention-days: 1

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [rust-docs, build-apple, build-android]
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download Rust documentation
        uses: actions/download-artifact@v4
        with:
          name: rust-docs
          path: docs/

      - name: Install markdown to HTML converter
        run: |
          pip3 install markdown pymdown-extensions pygments

      - name: Convert markdown files to HTML
        run: |
          python3 << 'EOF'
          import markdown
          import os
          from datetime import datetime

          # Configuration for markdown extensions
          extensions = [
              'markdown.extensions.extra',
              'markdown.extensions.codehilite',
              'markdown.extensions.toc',
              'markdown.extensions.tables',
              'markdown.extensions.fenced_code',
          ]

          extension_configs = {
              'codehilite': {
                  'css_class': 'highlight',
                  'linenums': False,
              }
          }

          # HTML template
          template = '''<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>{title} - Rust Multiplatform Template</title>
              <style>
                  body {{
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                      line-height: 1.6;
                      color: #333;
                      max-width: 900px;
                      margin: 0 auto;
                      padding: 20px;
                      background: #f8f9fa;
                  }}
                  .container {{
                      background: white;
                      padding: 40px;
                      border-radius: 8px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }}
                  h1, h2, h3, h4 {{ color: #004e89; }}
                  h1 {{ border-bottom: 3px solid #ff6b35; padding-bottom: 10px; }}
                  h2 {{ border-bottom: 2px solid #1a659e; padding-bottom: 8px; margin-top: 30px; }}
                  code {{
                      background: #f5f5f5;
                      padding: 2px 6px;
                      border-radius: 3px;
                      font-family: 'Monaco', 'Menlo', monospace;
                      font-size: 0.9em;
                  }}
                  pre {{
                      background: #f5f5f5;
                      padding: 15px;
                      border-radius: 5px;
                      border-left: 4px solid #1a659e;
                      overflow-x: auto;
                  }}
                  pre code {{
                      background: none;
                      padding: 0;
                  }}
                  a {{ color: #1a659e; text-decoration: none; }}
                  a:hover {{ color: #ff6b35; text-decoration: underline; }}
                  table {{
                      width: 100%;
                      border-collapse: collapse;
                      margin: 20px 0;
                  }}
                  th, td {{
                      padding: 12px;
                      text-align: left;
                      border: 1px solid #ddd;
                  }}
                  th {{
                      background: #004e89;
                      color: white;
                  }}
                  tr:nth-child(even) {{ background: #f9f9f9; }}
                  blockquote {{
                      border-left: 4px solid #ff6b35;
                      padding-left: 20px;
                      margin-left: 0;
                      color: #666;
                      font-style: italic;
                  }}
                  .nav {{
                      background: #004e89;
                      color: white;
                      padding: 15px 20px;
                      border-radius: 5px;
                      margin-bottom: 30px;
                  }}
                  .nav a {{
                      color: white;
                      margin-right: 20px;
                      font-weight: 500;
                  }}
                  .nav a:hover {{ color: #ff6b35; }}
              </style>
          </head>
          <body>
              <div class="nav">
                  <a href="index.html">üè† Home</a>
                  <a href="README.html">üìã README</a>
                  <a href="DEVELOPMENT.html">üîß Development</a>
                  <a href="UDL_GUIDE.html">üéØ UDL Guide</a>
                  <a href="SWIFT_EXAMPLES.html">üçé Swift Examples</a>
                  <a href="KOTLIN_EXAMPLES.html">ü§ñ Kotlin Examples</a>
                  <a href="lib/index.html">üìñ API Docs</a>
              </div>
              <div class="container">
                  {content}
              </div>
          </body>
          </html>'''

          # Files to convert (from docs_src/)
          files_to_convert = [
              ('README.md', 'Getting Started'),
              ('DEVELOPMENT.md', 'Development Guide'),
              ('CONTRIBUTING.md', 'Contributing Guide'),
              ('docs_src/UDL_GUIDE.md', 'UniFFI UDL Guide'),
              ('docs_src/SWIFT_EXAMPLES.md', 'Swift Examples'),
              ('docs_src/KOTLIN_EXAMPLES.md', 'Kotlin Examples'),
              ('docs_src/TESTING.md', 'Testing Guide'),
          ]

          for md_file, title in files_to_convert:
              if os.path.exists(md_file):
                  print(f'Converting {md_file}...')
                  with open(md_file, 'r', encoding='utf-8') as f:
                      md_content = f.read()

                  # Convert markdown to HTML
                  html_content = markdown.markdown(
                      md_content,
                      extensions=extensions,
                      extension_configs=extension_configs
                  )

                  # Wrap in template
                  full_html = template.format(
                      title=title,
                      content=html_content
                  )

                  # Determine output path - all go to docs/
                  output_file = f'docs/{os.path.basename(md_file).replace(".md", ".html")}'

                  # Write HTML file
                  with open(output_file, 'w', encoding='utf-8') as f:
                      f.write(full_html)

                  print(f'  ‚Üí Created {output_file}')
              else:
                  print(f'Warning: {md_file} not found, skipping.')

          print('Documentation conversion complete!')
          EOF

      - name: Update index.html with build info
        run: |
          GITHUB_SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          if [ -f docs/index.html ]; then
            sed -i "s/{{ GITHUB_SHA }}/$GITHUB_SHA_SHORT/g" docs/index.html
            sed -i "s/{{ BUILD_DATE }}/$BUILD_DATE/g" docs/index.html
          fi

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for documentation changes
        id: check_changes
        run: |
          git add docs/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No documentation changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Documentation changes detected"
          fi

      - name: Commit and push documentation
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git commit -m "docs: update generated documentation [skip ci]"
          git push origin main

      - name: Deploy to GitHub Pages
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'docs: deploy documentation from ${{ github.sha }}'

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/
          retention-days: 30
